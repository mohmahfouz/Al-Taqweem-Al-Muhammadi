<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقويم المحمدي</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Amiri', serif; background: linear-gradient(to bottom, #2E5B3F, #1B4D3E); color: #FDF6E3; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .main-container { background: rgba(245, 233, 214, 0.9); border-radius: 1.25rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25); padding: 2.5rem; max-width: 28rem; width: 100%; text-align: center; position: relative; overflow: hidden; }
        .main-container::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.05"%3E%3Ccircle cx="20" cy="20" r="10" fill="%23FDF6E3" fill-opacity="0.5"/%3E%3Cpath d="M50 10 L53 18 L61 18 L55 23 L57 31 L50 27 L43 31 L45 23 L39 18 L47 18 Z" fill="%23FDF6E3"/%3E%3Ccircle cx="80" cy="80" r="3" fill="%23FDF6E3"/%3E%3Ccircle cx="70" cy="30" r="2" fill="%23FDF6E3"/%3E%3Cpath d="M30 60 A20 20 0 0 1 10 60 A20 20 0 0 1 30 60 Z" fill="%23FDF6E3" stroke="%23FDF6E3" stroke-width="1"/%3E%3C/svg%3E'); background-size: 80px; pointer-events: none; }
        .title-container { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        h1 { font-size: 3rem; color: #1B4D3E; margin: 0; }
        .subtitle { font-size: 1.5rem; color: #1B4D3E; margin: 0.5rem 0 0; }
        .save-link { color: #1B4D3E; font-size: 1rem; text-decoration: none; transition: color 0.3s ease; }
        .save-link:hover { color: #3A6F4A; text-decoration: underline; }
        select { background: #F5E9D6; border: 1px solid #1B4D3E; border-radius: 0.5rem; padding: 0.75rem; width: 100%; color: #1B4D3E; font-size: 1rem; margin-bottom: 0.5rem; transition: border-color 0.3s ease; }
        select option { color: #1B4D3E; background: #F5E9D6; }
        select:focus { border-color: #3A6F4A; outline: none; }
        input[type="date"] { background: #F5E9D6; border: 1px solid #1B4D3E; border-radius: 0.5rem; padding: 0.75rem; width: 100%; color: #1B4D3E; font-size: 1rem; margin-bottom: 0.5rem; transition: border-color 0.3s ease; }
        input[type="date"]:focus { border-color: #3A6F4A; outline: none; }
        #coordinates { font-size: 0.875rem; color: #0A2D4A; margin-bottom: 1rem; }
        .today-container { background: #1B4D3E; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .today-container h3 { font-size: 1.5rem; color: #FDF6E3; margin: 0 0 0.5rem 0; }
        .today-container p { font-size: 1.125rem; color: #FDF6E3; margin: 0.5rem 0; }
        .time-card { background: #F5E9D6; border-radius: 1rem; padding: 1.25rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .time-card:hover { transform: translateY(-5px); box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2); }
        .time-card h2 { font-size: 1.25rem; color: #1B4D3E; margin-bottom: 0.5rem; }
        .time-card p { font-size: 1rem; color: #0A2D4A; margin: 0.25rem 0; }
        .info-container { background: #F5E9D6; border-radius: 1rem; padding: 1.25rem; margin-bottom: 1.5rem; font-size: 1rem; color: #0A2D4A; line-height: 1.6; } /* Increased font size */
        .conversion-container { background: #F5E9D6; border-radius: 1rem; padding: 1.25rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .conversion-container h2 { font-size: 1.25rem; color: #1B4D3E; margin-bottom: 1rem; }
        .conversion-controls { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-bottom: 1rem; }
        .conversion-controls select, .conversion-controls input { flex: 1; min-width: 120px; }
        .conversion-result { background: #1B4D3E; border-radius: 0.75rem; padding: 1rem; color: #FDF6E3; margin-top: 1rem; }
        .conversion-result h3 { font-size: 1.5rem; color: #FDF6E3; margin: 1rem 0 0.5rem 0; }
        .book-container { background: #F5E9D6; border-radius: 1rem; padding: 1.25rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); font-size: 1rem; color: #0A2D4A; line-height: 1.6; }
        .book-container h2 { font-size: 1.25rem; color: #1B4D3E; margin-bottom: 1rem; }
        .book-nav { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; }
        footer { font-size: 0.875rem; color: #0A2D4A; margin-top: 2rem; }
        .button-group { margin: 0.5rem 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
        .button { font-size: 1rem; padding: 0.75rem; cursor: pointer; background: #1B4D3E; color: #FDF6E3; border: none; border-radius: 0.5rem; transition: background 0.3s ease, transform 0.2s ease; width: 100%; max-width: 100%; box-sizing: border-box; }
        .button:hover { background: #3A6F4A; transform: scale(1.05); }
        .inline-button { padding: 0.75rem; font-size: 1rem; }
        .inline-button.arrow { font-size: 1rem; padding: 0.75rem; }
        #slider, #time-slider { width: 90%; margin: 0.5rem auto; height: 8px; background: #3A6F4A; border-radius: 5px; outline: none; -webkit-appearance: none; }
        #slider::-webkit-slider-thumb, #time-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #1B4D3E; border-radius: 50%; cursor: pointer; transition: transform 0.3s ease; }
        #slider::-webkit-slider-thumb:hover, #time-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }
        #current-time { font-size: 1rem; color: #0A2D4A; margin-bottom: 0.5rem; }
        #remaining-time { font-size: 1rem; color: #3A6F4A; margin-bottom: 0.5rem; }
        .info-container a { color: #1B4D3E; text-decoration: none; display: block; margin: 0.5rem 0; transition: color 0.3s ease; }
        .info-container a:hover { color: #3A6F4A; text-decoration: underline; }
        .facebook-icon { width: 16px; height: 16px; vertical-align: middle; margin-left: 5px; }
        .conversion-navigation { margin-top: 1rem; }
        .occasion-info { font-style: italic; color: #F5E9D6; }
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .header-titles { text-align: right; }
        .mansion-nav { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; }
        .picker-group { flex: 1; min-width: 120px; display: flex; flex-direction: column; align-items: stretch; }
        .tabs { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; }
        .tab { padding: 0.75rem 1.5rem; background: #1B4D3E; color: #FDF6E3; border-radius: 0.5rem 0.5rem 0 0; cursor: pointer; transition: background 0.3s; }
        .tab.active { background: #F5E9D6; color: #1B4D3E; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header-section">
            <div class="header-titles">
                <h1>التقويم المحمدي</h1>
                <p class="subtitle">مع مواقيت الصلاة و أداة للمقابلة</p>
            </div>
            <a href="index.html" download class="save-link">حفظ الصفحة</a>
        </div>

        <div class="info-container">
            <p>التقويم المحمدى هو نتيجة بحث السيد الأستاذ فرقد الحسينى القزوينى دام فيضه: لا علاقة له بحركة القمر. بل هو: تقويم شمسى نجمى يعتمد على حركة الشمس فى منازلها لمعرفة مواقع الشهور فى الفصول أولا. ومعرفة عدد السنين. المصدر كتاب فيض العليم في معرفة التقويم للسيد الأستاذ فرقد الحسيني القزويني</p>
            <a href="https://drive.google.com/file/d/1KonLhpZ8gsSPl1UlbjyxGm1kHHQaQmTQ/view?fbclid=IwY2xjawM3-HtleHRuA2FlbQIxMABicmlkETEyZWVrR0RZejFUYzN5T0FVAR4YHrEAXzr9WSySCkqQLw0HDZshjLcBYhl22b9EPQJtHh1tNdliO_PRcPQdEQ_aem_yCNWTOaAr28eYVfRsxK3dw">التقويم المحمدي السنوي في الرابط التالي</a>
            <a href="https://books.google.com.eg/books/about/%D9%81%D9%8A%D8%B6_%D8%A7%D9%84%D8%B9%D9%84%D9%8A%D9%85_%D9%81%D9%8A_%D9%85%D8%B9%D8%B1%D9%81%D8%A9_%D8%A7%D9%84.html?id=OyO1EAAAQBAJ&redir_esc=y">رابط كتاب فيض العليم فى معرفة التقويم</a>
            <a href="https://www.facebook.com/AlhillaNgo" title="مؤسسة الحلة للدراسات الإنسانية والعلمية والدينية/ بابل">
                <svg class="facebook-icon" viewBox="0 0 24 24" fill="#1B4D3E">
                    <path d="M12 2.04c-5.5 0-10 4.49-10 10 0 4.99 3.66 9.13 8.44 9.88v-6.98h-2.54v-2.9h2.54v-2.21c0-2.51 1.49-3.89 3.78-3.89 1.09 0 2.24.19 2.24.19v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.77l-.44 2.9h-2.33v6.98c4.78-.75 8.44-4.89 8.44-9.88 0-5.51-4.5-10-10-10z"/>
                </svg>
                مؤسسة الحلة للدراسات الإنسانية والعلمية والدينية/ بـــــابـــــــل
            </a>
        </div>
        <div class="tabs">
            <div class="tab active" data-tab="today">اليوم</div>
            <div class="tab" data-tab="prayer">مواقيت الصلاة</div>
            <div class="tab" data-tab="conversion">مقابلة</div>
            <div class="tab" data-tab="book">من كتاب فيض العليم</div>
        </div>

        <div class="today-container">
            <h3>اليوم</h3>
            <p id="muhammadan-date">--</p>
            <p id="gregorian-date">--</p>
            <p id="occasion-info" class="occasion-info">المناسبات: --</p>
            <h3>حركة الشمس فى منازلها</h3>
            <p id="today-mansion-info-rising">الطالع بالغداة: --</p>
            <p id="today-mansion-info-setting">الغارب بالغداة: --</p>
            <p id="today-mansion-info-quote">يقول ساجع العرب: --</p>
        </div>

        <div id="solar-times" style="display: none;">
            <div class="time-card">
                <select id="city-select" aria-label="اختر المدينة">
                    <option value="najaf" selected>النجف، العراق</option>
                    <option value="karbala">كربلاء، العراق</option>
                    <option value="al_hilla">الحلة، العراق</option>
                    <option value="cairo">القاهرة، مصر</option>
                    <option value="alexandria">الإسكندرية، مصر</option>
                    <option value="port_said">بورسعيد، مصر</option>
                </select>
                <p id="coordinates">الإحداثيات: --</p>
                <p id="current-time">--</p>
                <input type="range" id="time-slider" min="0" max="1440" value="0" disabled>
                <p id="remaining-time">--</p>
                <h2>مواقيت الصلاة</h2>
                <p><strong>صلاة الفجر</strong>: <span id="astronomical-twilight-start">--</span></p>
                <p><strong>طلوع الشمس</strong>: <span id="sunrise">--</span></p>
                <p><strong>صلاة الظهر</strong>: <span id="solar-noon">--</span></p>
                <p><strong>غروب الشمس</strong>: <span id="sunset">--</span></p>
                <p><strong>صلاة المغرب</strong>: <span id="civil-twilight-end">--</span></p>
            </div>
            <div class="time-card">
                <p><strong>وقت الإفطار(اذان المغرب + 15 دقيقىة)</strong>: <span id="iftar">--</span></p>
                <p><strong>منتصف الليل</strong>: <span id="night-prayer">--</span></p>
            </div>
            <div class="time-card">
                <h2>الشفق</h2>
                <p><strong>بداية الشفق الملاحى للفجر (12 درجة تحت الأفق)</strong>: <span id="nautical-twilight-start">--</span></p>
                <p><strong>نهاية الشفق المدنى للمغرب (6 درجات تحت الأفق)</strong>: <span id="civil-twilight-end2">--</span></p>
                <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">طريقة الحساب: (جعفرى) - الفجر: 17.7°، المغرب: 4.5°</p>
            </div>
        </div>

        <div class="conversion-container" style="display: none;">
            <h2>المقابلة بين التقويم المحمدي والتقويم الشمسي الحالي (الميلادي)</h2>
            <div class="conversion-navigation">
                <div class="conversion-controls">
                    <div class="picker-group">
                        <button id="prevDay" class="button inline-button arrow">اليوم السابق</button>
                        <select id="conversion-custom-day"></select>
                        <button id="nextDay" class="button inline-button arrow">اليوم التالي</button>
                    </div>
                    <div class="picker-group">
                        <button id="prevCustomMonth" class="button inline-button">الشهر السابق</button>
                        <select id="conversion-custom-month"></select>
                        <button id="nextCustomMonth" class="button inline-button">الشهر القادم</button>
                    </div>
                    <div class="picker-group">
                        <button id="prevYear" class="button inline-button">العام السابق</button>
                        <select id="conversion-custom-year"></select>
                        <button id="nextYear" class="button inline-button">العام القادم</button>
                    </div>
                </div>
                <div class="conversion-controls">
                    <input type="date" id="conversion-gregorian-picker" min="0620-01-01" max="2089-12-31">
                </div>
                <input type="range" id="slider" min="0" max="364" value="0">
                <div class="reset-button-container">
                    <button id="resetDay" class="button">إعادة ضبط اليوم</button>
                </div>
            </div>
            <div class="conversion-result">
                <p id="conversion-muhammadan-date">--</p>
                <p id="conversion-gregorian-date">--</p>
                <p id="conversion-occasion">--</p>
                <h3>حركة الشمس فى منازلها</h3>
                <p id="conversion-mansion-info-rising">الطالع بالغداة: --</p>
                <p id="conversion-mansion-info-setting">الغارب بالغداة: --</p>
                <p id="conversion-mansion-info-quote">يقول ساجع العرب: --</p>
                <div class="mansion-nav">
                    <button id="conversion-prevMansion" class="button inline-button">المنزلة السابقة</button>
                    <button id="conversion-nextMansion" class="button inline-button">المنزلة التالية</button>
                </div>
            </div>
        </div>

        <div class="book-container" style="display: none;">
            <h2>من كتاب فيض العليم في معرفة التقويم</h2>
            <div id="book-content"></div>
            <div class="book-nav">
                <button id="book-prev-page" class="button inline-button">الصفحة السابقة</button>
                <button id="book-next-page" class="button inline-button">الصفحة التالية</button>
            </div>
        </div>

        <footer>2025 © اسم المصمم: محمد محفوظ</footer>
    </div>
    <script>
        const cities = {
            najaf: { lat: 32.02594, lng: 44.34625, name: 'النجف، العراق', timezone: 'Asia/Baghdad' },
            karbala: { lat: 32.61603, lng: 44.02488, name: 'كربلاء، العراق', timezone: 'Asia/Baghdad' },
            al_hilla: { lat: 32.46367, lng: 44.41963, name: 'الحلة، العراق', timezone: 'Asia/Baghdad' },
            cairo: { lat: 30.06263, lng: 31.24967, name: 'القاهرة، مصر', timezone: 'Africa/Cairo' },
            alexandria: { lat: 31.21564, lng: 29.95527, name: 'الإسكندرية، مصر', timezone: 'Africa/Cairo' },
            port_said: { lat: 31.25654, lng: 32.28411, name: 'بورسعيد، مصر', timezone: 'Africa/Cairo' }
        };
        const months = ["رمضان", "شوال", "جمادى الأولى", "جمادى الآخرة", "رجب", "ربيع الأول", "ربيع الآخر", "ذي القعدة", "ذي الحجة", "محرم", "صفر", "شعبان"];
        const baseSpecialDays = ["يوم التقويم الأول", "يوم التقويم الثاني", "يوم التقويم الثالث", "يوم التقويم الرابع", "يوم التقويم الخامس"];
        let selectedTimezone = "Asia/Baghdad"; // Will be updated per city selection
        const syriacMonths = ['كانون الثاني', 'شباط', 'آذار', 'نيسان', 'أيار', 'حزيران', 'تموز', 'آب', 'أيلول', 'تشرين الأول', 'تشرين الثاني', 'كانون الأول'];
        const occasions = [
            {month: "رمضان", day: "1", occasion: "ليلة القدر"},
            {month: "رمضان", day: "10", occasion: "وفاة السيدة خديجة عليها السلام"},
            {month: "رمضان", day: "15", occasion: "ميلاد الإمام الحسن بن ابي طالب عليه السلام"},
            {month: "رمضان", day: "19", occasion: "جرح أمير المؤمنين عليه السلام"},
            {month: "رمضان", day: "21", occasion: "إستشهاد الإمام علي بن ابي طالب عليه السلام"},
            {month: "شوال", day: "1", occasion: "عيد الفطر"},
            {month: "شوال", day: "15", occasion: "معركة احد واستشهاد الحمزة عليه السلام"},
            {month: "شوال", day: "25", occasion: "إستشهاد الإمام جعفر الصادق عليه السلام"},
            {month: "جمادى الأولى", day: "5", occasion: "ولادة السيدة زينب بنت علي بن ابي طالب عليه السلام سنة 5 هجري"},
            {month: "جمادى الأولى", day: "13", occasion: "استشهاد فاطمه الزهراء عليها السلام على رواية"},
            {month: "جمادى الآخرة", day: "3", occasion: "وفاة السيدة فاطمة الزهراء عليها السلام على رواية"},
            {month: "جمادى الآخرة", day: "13", occasion: "وفاة أم البنين عليها السلام"},
            {month: "جمادى الآخرة", day: "20", occasion: "ولادة فاطمة الزهراء عليها السلام"},
            {month: "رجب", day: "1", occasion: "ولادة الإمام علي بن محمد الباقر عليه السلام"},
            {month: "رجب", day: "2", occasion: "وفاة الإمام علي بن محمد الهادي عليه السلام"},
            {month: "رجب", day: "3", occasion: "ولادة الإمام علي بن محمد الهادي عليه السلام"},
            {month: "رجب", day: "10", occasion: "ولادة الإمام محمد بن علي الجواد عليه السلام"},
            {month: "رجب", day: "13", occasion: "ولادة الإمام علي بن ابي طالب عليه السلام"},
            {month: "رجب", day: "15", occasion: "وفاة السيدة زينب بنت علي عليهما السلام"},
            {month: "رجب", day: "25", occasion: "استشهاد الامام الكاظم عليه السلام"},
            {month: "رجب", day: "26", occasion: "وفاة ابي طالب عليه السلام"},
            {month: "رجب", day: "27", occasion: "بعثة النبي صلى الله عليه و آله و سلم"},
            {month: "ربيع الأول", day: "8", occasion: "شهادة الامام الحسن العسكري عليه السلام"},
            {month: "ربيع الأول", day: "10", occasion: "وفاة عبد المطلب عليه السلام"},
            {month: "ربيع الأول", day: "12", occasion: "ولادة النبي صلى الله عليه و آله على رواية"},
            {month: "ربيع الأول", day: "17", occasion: "ولادة النبي صلى الله عليه و آله وولادة الإمام جعفر الصادق عليه السلام"},
            {month: "ربيع الآخر", day: "8", occasion: "شهادة السيدة فاطمة الزهراء عليها السلام على رواية"},
            {month: "ربيع الآخر", day: "10", occasion: "ولادة الإمام الحسن العسكري عليه السلام"},
            {month: "ذي القعدة", day: "11", occasion: "ولادة الإمام علي بن موسى الرضا عليه السلام"},
            {month: "ذي القعدة", day: "25", occasion: "يوم دحو الأرض"},
            {month: "ذي القعدة", day: "30", occasion: "شهادة الامام محمد الجواد عليه السلام"},
            {month: "ذي الحجة", day: "1", occasion: "زواج امير المؤمنين عليه السلام من فاطمة الزهراء عليها السلام"},
            {month: "ذي الحجة", day: "7", occasion: "شهادة الامام الباقر عليه السلام"},
            {month: "ذي الحجة", day: "9", occasion: "شهادة مسلم بن عقيل عليه السلام"},
            {month: "ذي الحجة", day: "10", occasion: "عيد الأضحى"},
            {month: "ذي الحجة", day: "18", occasion: "عيد الغدير"},
            {month: "ذي الحجة", day: "24", occasion: "يوم المباهلة"},
            {month: "محرم", day: "10", occasion: "يوم إستشهاد الحسين عليه السلام"},
            {month: "محرم", day: "25", occasion: "إستشهاد الإمام علي بن الحسين عليه السلام"},
            {month: "صفر", day: "3", occasion: "والدة الإمام الباقر عليه السلام"},
            {month: "صفر", day: "7", occasion: "إستشهاد الإمام الحسن بن علي عليه السلام"},
            {month: "صفر", day: "20", occasion: "أربعين الإمام الحسين عليه السلام"},
            {month: "صفر", day: "28", occasion: "إستشهاد النبي صلى الله عليه و آله"},
            {month: "صفر", day: "30", occasion: "إستشهاد الإمام الرضا عليه السلام"},
            {month: "شعبان", day: "3", occasion: "ولادة الإمام الحسين عليه السلام"},
            {month: "شعبان", day: "4", occasion: "ولادة العباس عليه السلام"},
            {month: "شعبان", day: "5", occasion: "ولادة الإمام علي بن الحسين عليه السلام"},
            {month: "شعبان", day: "15", occasion: "ولادة الإمام المهدي عليه السلام"}
        ];
        const mansions = [
            {"التاريخ": "2025-01-02", "الطالع بالغداة": "الشولة", "الغارب بالغداة": "الهقعة", "يقول ساجع العرب": "اذا طلعت الشولة اعجلت الشيخ البولة واشتدت على العائل العولة"},
            {"التاريخ": "2025-01-15", "الطالع بالغداة": "النعائم", "الغارب بالغداة": "الهنعة", "يقول ساجع العرب": "اذا طلعت النعائم توسفت التهائم وخلص البرد الى كل نائم وتلاقى الرعاء بالنمائم"},
            {"التاريخ": "2025-01-28", "الطالع بالغداة": "البلدة", "الغارب بالغداة": "الذراع", "يقول ساجع العرب": "اذا طلعت البلده حممت الجعده واكلت القشده وقيل للبرد اهده"},
            {"التاريخ": "2025-02-10", "الطالع بالغداة": "سعد الذابح", "الغارب بالغداة": "النثرة", "يقول ساجع العرب": "اذا طلع سعد الذابح حمى اهله النابح ونفع اهله الرائح وتصبح السارح وظهر فى الحى الانافح"},
            {"التاريخ": "2025-02-23", "الطالع بالغداة": "سعد بلع", "الغارب بالغداة": "الطرفة", "يقول ساجع العرب": "اذا طلع سعد بلع اقتحم الربع ولحق الهبع وصيد المرع وصار فى الارض لمع"},
            {"التاريخ": "2025-03-08", "الطالع بالغداة": "سعد السعود", "الغارب بالغداة": "الجبهة", "يقول ساجع العرب": "اذا طلع سعد السعود نظر العود ولانت الجلود وذاب كل محمود وكره الناس فى الشمس القعود"},
            {"التاريخ": "2025-03-21", "الطالع بالغداة": "سعد الأخبية", "الغارب بالغداة": "الزبرة", "يقول ساجع العرب": "اذا طلع سعد الاخبية دهنت الاسقيه ونزلت الاحوية وتجاورت الابنيه"},
            {"التاريخ": "2025-04-03", "الطالع بالغداة": "الفرغ الأول", "الغارب بالغداة": "الصرفة", "يقول ساجع العرب": "اذا طلع الدلو هيب الجزو وانسل العفو وطلب اللهو الخلو"},
            {"التاريخ": "2025-04-16", "الطالع بالغداة": "الفرغ المؤخر", "الغارب بالغداة": "السماك", "يقول ساجع العرب": "اذا طلع الدلو هيب الجزو وانسل العفو وطلب اللهو الخلو"},
            {"التاريخ": "2025-04-29", "الطالع بالغداة": "السمكة", "الغارب بالغداة": "السماك", "يقول ساجع العرب": "اذا طلعت السمكه نصبت الشبكه وامكنت الحركه وتعلقت بالثوب الحسكه وطاب الزمان للنسكه"},
            {"التاريخ": "2025-05-12", "الطالع بالغداة": "الشرطان", "الغارب بالغداة": "الغفر", "يقول ساجع العرب": "اذا طلع الشرطان استوى الزمان وحضرت الاوطان وتهادى الجيران"},
            {"التاريخ": "2025-05-25", "الطالع بالغداة": "البطين", "الغارب بالغداة": "الزبانى", "يقول ساجع العرب": "اذا طلع البطين اقتضى الدين وظهر الزين واقتفى بالعطار و الزين"},
            {"التاريخ": "2025-06-07", "الطالع بالغداة": "الثريا", "الغارب بالغداة": "الإكليل", "يقول ساجع العرب": "اذا طلع النجم فالحر فى حدم و العشب فى حطم والعانات فى كدم"},
            {"التاريخ": "2025-06-20", "الطالع بالغداة": "الدبران", "الغارب بالغداة": "القلب", "يقول ساجع العرب": "اذا طلعت الدبران توقدت الحزان وكرهت النيران واستعرت الذبان وبيست الغدران ورمت بانفسها حيث شاءت الصبيان"},
            {"التاريخ": "2025-07-03", "الطالع بالغداة": "الهقعة", "الغارب بالغداة": "الشولة", "يقول ساجع العرب": "اذا طلعت الهقعة تقوضت الناس للقلعة ورجعوا عن النجعه واردفتها الهنعة"},
            {"التاريخ": "2025-07-16", "الطالع بالغداة": "الهنعة", "الغارب بالغداة": "النعائم", "يقول ساجع العرب": "اذا طلعت الجوزاء توقدت المعزاء وكنست الضباء وعرقت العلباء وطاب الخباء"},
            {"التاريخ": "2025-07-29", "الطالع بالغداة": "الذراع", "الغارب بالغداة": "البلدة", "يقول ساجع العرب": "اذا طلعت الذراع حسرت الشمس القناع واشعلت فى الافق الشعاع وترقرق السراب بكل قاع"},
            {"التاريخ": "2025-08-11", "الطالع بالغداة": "النثرة", "الغارب بالغداة": "سعد الذابح", "يقول ساجع العرب": "اذا طلعت النثرة قنأة البسرة وجنى النخل بكره وأوت المواشى حجره ولم تترك ف ذات در قطره"},
            {"التاريخ": "2025-08-24", "الطالع بالغداة": "الطرف", "الغارب بالغداة": "سعد بلع", "يقول ساجع العرب": "اذا طلعت الطرفة بكرت الخرفة وكثرت الطرفة وهانت للضيف الكلفة"},
            {"التاريخ": "2025-09-06", "الطالع بالغداة": "الجبهة", "الغارب بالغداة": "سعد السعود", "يقول ساجع العرب": "اذا طلعت الجبهة تحانت الولهه وتنازت السفهة وقلت فى الارض الرفهة"},
            {"التاريخ": "2025-09-20", "الطالع بالغداة": "الزبرة", "الغارب بالغداة": "سعد الأخبية", "يقول ساجع العرب": "اذا طلعت الزبرة طاب الزمان جنى البسر فى كل مكان"},
            {"التاريخ": "2025-10-03", "الطالع بالغداة": "الصرفة", "الغارب بالغداة": "الفرغ الأول", "يقول ساجع العرب": "اذا طلعت الصرفة احتال كل ذي حرفة وجفر كل ذي نطفة وامتيز عن المياه زلفه"},
            {"التاريخ": "2025-10-16", "الطالع بالغداة": "العواء", "الغارب بالغداة": "الفرغ المؤخر", "يقول ساجع العرب": "إذا طلعت العواء ضرب الخباء وطاب الهواء وكره العراء وشنن السقاء"},
            {"التاريخ": "2025-10-29", "الطالع بالغداة": "السماك", "الغارب بالغداة": "السمكة", "يقول ساجع العرب": "لذا طلع السماك ذهب العكاك وقل على الماء اللكاك"},
            {"التاريخ": "2025-11-11", "الطالع بالغداة": "الغفر", "الغارب بالغداة": "الشرطان", "يقول ساجع العرب": "اذا طلع الغفر اقشعر السفر وتربل النضر وحسن فى العين الجمر"},
            {"التاريخ": "2025-11-24", "الطالع بالغداة": "الزبانى", "الغارب بالغداة": "البطين", "يقول ساجع العرب": "اذا طلعت الزبانى احدثت لكل ذي عيال شانا ولكل ذي mاشية هوانا"},
            {"التاريخ": "2025-12-07", "الطالع بالغداة": "الإكليل", "الغارب بالغداة": "الثريا", "يقول ساجع العرب": "اذا طلع الإكليل هاجت الفحول وتخوفت السيول"},
            {"التاريخ": "2025-12-20", "الطالع بالغداة": "القلب", "الغارب بالغداة": "الدبران", "يقول ساجع العرب": "اذا طلع القلب جاء الشتاء كالكلب وصار اهل البوادي فى كرب ولا يمكن الفحل الا ذات ثرب"}
        ];
        let todayGregYear = 2025;
        let todayIndex = 0;
        let baseGregYear = 2025;
        let baseIndex = 0;
        let simulatedTime = null;
        let isPickerChange = false;
        let currentPrayerDate = null;
        let prayerTimes = null;
        let currentBookPage = 1;
        const totalBookPages = 9; // Updated to include new pages
        const bookPages = [
            // Page 1 (original)
            `<p>التقويم نجمي شمسي في روايات أهل البيت عليهم السلام.</p>
            <p>قال الصادق عليه السلام للمفضل بن عمرو : فكر الآن في تنقل الشمس في البروج الاثني عشر الإقامة دور السنة وما في ذلك من التدبير فهو الدور الذي تصح الأزمنة الأربعة من السنة الشتاء والربيع والصيف والخريف تستوفيها على التمام ، وفي هذا المقدار من دوران الشمس تدرك الغلات والثمار، وتنتهى إلى غاياتهم ثم تعود فيستأنف النشو والنمو.. ألا ترى أن السنة مقدار مسير الشمس من الحمل إلى الحمل . فبالسنة وأخواتها يكال الزمان من لدن خلق الله تعالى العالم، إلى كل وقت وعصر من غابر الأيام، وبها يحسب الأعمار والأوقات المؤقتة للديون والإجارات والمعاملات ، وغير ذلك من أمورهم، وبمسير الشمس تكمل السنة ، ويقوم حساب الزمان على الصحة .</p>
            <p>وفي باب الاستدلال بالقمر</p>
            <p>يقول الصادق عليه السلام للمفضل بن عمرو استدل بالقمر ففيه دلالة جليلة تستعملها العامة في معرفة الشهور، ولا يقوم عليه حساب السنة ، لأن دوره لا يستوفي الأزمنة الأربعة ونشوء الثمار وتصرمها، ولذلك صارت شهور القمر وسنوه تتخلف عن شهور الشمس وسنيها، وصار الشهر من شهور القمر ينتقل ، فيكون مرة بالشتاء ومرة بالصيف</p>
            <p><strong>تأمل رقم واحد :</strong> في قول المعصوم : تستعمله العامة في معرفة الشهور ما المقصود بالعامة ؟ عامة الناس أم العامة في مقابل الخاصة ؟</p>
            <p><strong>تأمل رقم اثنين :</strong> لا يقوم عليه حساب السنة ، لأن دوره لا يستوفي الأزمنة الأربعة ونشوء الثمار وتصرمها على هذا لا يوجد تقويم يسمى تقويما قمريا محضا .</p>
            <p><strong>تأمل رقم ثلاثة :</strong> قوله عليه السلام : وبها أي الشمس : يحسب الأعمار والأوقات المؤقتة للديون والإجارات والمعاملات ، وغير ذلك من أمورهم ، وبمسير الشمس تكمل السنة ، ويقوم حساب الزمان على الصحة .</p>
            <p>وهذا القول يعارض ما ذهب إليه العامة والخاصة عند تفسيرهم لقوله تعالى : يسألونك عن الاهلة .</p>
            <p>ويستمر الإمام الصادق في بيان فوائد القمر فيقول : فكر في إنارته في ظلمة الليل والأرب في ذلك فإنه مع الحاجة الظلمة لهدوء الحيوان وبرد الهواء على النبات لم يكن صلاح في أن يكون الليل ظلمة داجية لا ضياء فيها، فلا يمكن فيه شيء من العمل، لأنه ربما احتاج الناس إلى العمل بالليل ، لضيق الوقت عليهم في بعض الأعمال في النهار، ولشدة الحر وإفراطه ، فيعمل في ضوء القمر أعمالا شتى ، كحرث الأرض ، وضرب اللبن ، وقطع الخشب، وما أشبه ذلك ، فجعل ضوء القمر معونة للناس على معائشهم إذا احتاجوا إلى ذلك ، وأنسا للسائرين وجعل طلوعه في بعض . الليل دون بعض ونقص مع ذلك عن نور الشمس وضيائها ، لكيلا ينبسط الناس في العمل انبساطهم بالنهار، ويمتنعوا من الهدوء والقرار فيهلكهم ذلك ، وفي تصرف القمر خاصة في مهله ومحاقه وزيادته ونقصانه وكسوفه ، من التنبيه على قدرة الله تعالى خالفه المصرف له هذا التصريف الصلاح العالم ما يعتبر به المعتبرون</p>`,
            // Page 2
            `<p>اقول : تأمل في فوائد القمر عند الإمام عليه السلام حيث اخرجه عن الحساب العلمي : بل صرح أن القمر حساب العامة .</p>
            <p>وفي حديثه عن النجوم يقول عليه السلام :</p>
            <p>فكر في هذه النجوم التي تظهر في بعض السنة وتحتجب بعضها كمثل الثريا والجوزاء والشعريين وسهيل فإنها لو كانت بأسرها تظهر في وقت واحد لم يكن لواحد فيها على حياله دلالات يعرفها الناس ، ويهتدون بها لبعض أمورهم ، كمعرفتهم الآن بما يكون من طلوع الثور والجوزاء إذا طلعت ، واحتجابها إذا احتجيت فصار ظهور كل واحد واحتجابه في وقت الوقت غير الوقت الآخر، لينتفع الناس بما يدل عليه كل واحد على حدته ، وما جعلت الثريا وأشباهها تظهر حينا وتحتجب حينا إلا لضرب من المصلحة ، وكذلك جعلت بنات نعش ظاهرة لا تغيب الضرب آخر من المصلحة ، فإنها بمنزلة الأعلام التي يهتدي بها الناس في البر والبحر للطرق المجهولة ، وكذلك أنها لا تغيب ولا تتوارى فهم ينظرون إليها متى أرادوا أن يهتدوا بها إلى حيث شانوا ، وصار الأمران جميعا على اختلافهما موجهين نحو الأرب والمصلحة، وفيهما مارب أخرى علامات ودلالات على أوقات كثيرة من الأعمال ، كالزراعة والغراس والسفر في البر والبحر، وأشياء مما يحدث في الأزمنة من الأمطار والرياح والحر والبرد ، وبها يهتدي السائرون في ظلمة الليل ، لقطع القفار الموحشة واللجج الهائلة ، مع ما في ترددها في كبد السماء مقبلة ومديرة ومشرقة ومغربة من العبر .</p>
            <p>وهذا هو الحساب النجمي الذي لازال عليه المزارعون والرعاة .</p>
            <p>ما هي الأهلة ؟</p>
            <p>من كتاب فيض العليم في معرفة التقويم المحمدي لسماحة السيد الاستاذ فرقد الحسيني</p>
            <p>قال تعالى : ( يسألونك عن الأهلة قُلْ هي مواقيت للناس والحج وليس البر بأن تأتُوا الْبُيُوتَ مِنْ ظُهُورِهَا وَلَكِنْ الْبِرَّ مَنِ اتَّقَى وَأْتُوا الْبُيُوتَ مِنْ أَبْوَابِها وَاتَّقُوا اللهَ لَعَلَّكُمْ تُفْلِحُونَ } [البقرة: ۱۸۹].</p>
            <p>تفسير مجمع البيان</p>
            <p>ذكر الطبرسي في تفسيره ما يأتي :</p>
            <p>يسألونك عن الأهلة أي أحوال الأهلة في زيادتها ونقصانها ووجه الحكمة في ذلك (قل) يا محمد هي مواقيت للناس والحج أي هي مواقيت يحتاج الناس إلى مقاديرها في صومهم وفطرهم وعدد نسائهم ومحل ديونهم وحجهم فبين سبحانه أن وجه الحكمة في زيادة القمر ونقصانه ما تعلق بذلك من مصالح الدين والدنيا لأن الهلال لوكان مدورا أبدا مثل الشمس لم يمكن التوقيت به وفيه أوضح دلالة على أن الصوم لا يثبت بالعدد وأنه يثبت بالهلال لأنه سبحانه نص على أن الأهلة هي المعتبرة في المواقيت والدلالة على الشهور فلو كانت الشهور إنما تعرف بطريق العدد لخص التوقيت بالعدد دون رؤية الأهلة لأن عند أصحاب العدد لا عبرة برؤية الأهلة في معرفة المواقيت .</p>`,
            // Page 3
            `<p>أقول :</p>
            <p>كلمة الناس في القرآن الكريم تشمل الذكر والأنثى من بني ادم عليهم السلام على إختلاف الوانهم والسنتهم ومعتقداتهم ونص كلام الله المنزل على رسوله الأمين صلى الله عليه واله وسلم القرآن الكريم على أن القرآن المجيد هدى للناس فكل حكم فيه لا يشمل الناس فهو مردود.</p>
            <p>فهم الشيخ من كلمة الاهلة معنى اهلة الشهور القمرية وهذا الفهم هو ما عليه معظم المفسرين على إختلاف مذاهبهم .</p>
            <p>ولو تنزلنا وقلنا بصحته فإن اهلة الشهور يجب أن تكون ثابته في أماكنها من فصول السنة والسبب لأنها مواقيت للناس جميعا وليس للذين أمنوا برسول الله صلى الله عليه واله وسلم.</p>
            <p>ووفقا للروايات قال الشيخ أن السبب في اعتماد الأهلة لكونها مواقيت يحتاج الناس إلى مقاديرها في صومهم وقطرهم وعدد نسائهم ومحل ديونهم وحجهم .</p>
            <p>ولكن هذا الادعاء ينقضه الواقع فليس كل الناس يعتمدون على الأهلة وليس كلهم يصمون ولا نسائهم تعمل وفق الأحكام التي ذكرها الشيخ وباقي المفسرين ثم اذا كان الحج لجميع الناس فلماذا اقتصر الذهاب إلى البيت العتيق يخص المسلمين دون غيرهم ؟</p>
            <p>ثم قال قدس سره / وفيه أوضح دلالة على أن الصوم لا يثبت بالعدد وأنه يثبت بالهلال لأنه سبحانه نص على أن الأهلة هي المعتبرة في المواقيت والدلالة على الشهور فلو كانت الشهور إنما تعرف بطريق العدد الخص</p>
            <p>التوقيت بالعدد دون رؤية الأهلة .</p>
            <p>اتفق جميع الفقهاء إن عدة الشهر الواحد ثلاثون يوما وهذه الثلاثين لا يمكن أن تحصل عليها عن طريق القمر لأن دورته أقل من ٣٠ يوما وأكثر من ٢٩ يوما ثم كيف لا يثثبت الصوم بالعد والله تعالى يقول ولتكملوا العدة وما اتفق عليه الجميع من قول النبي صلى الله عليه واله وسلم فإذا غم عليكم فاكملوا العدة ؟</p>
            <p>أضف إلى ذلك أين الدليل في هذا الآية على أن الصيام بالأهلة ؟ فلو كان الله تعالى قاصدا معنى كلمة أهله كما فهمها المفسرون لقال هي مواقيت للناس والحج والصوم..... لكنه تعالى مجده ذكر الحج دونه لكونه عام للناس والصوم خاص لأنه خطاب موجه للذين آمنوا ..</p>
            <p>واذا تمعنا فيما بقي من الآية الشريفة لعلمنا معنى الاهلة وعرفنا سبب النهي عن إتيان البيوت من ظهورها</p>
            <p>تفسير الكشاف</p>
            <p>يسئلونك عن الأهلة . يحتمل هذا السؤال أمرين إذا نظرنا إليه مستقلا عن جوابه :</p>
            <p>الأول أن يكون السؤال عن السبب الطبيعي لاختلاف ما يبدو أولا من دقة الهلال : ثم تمامه بدرا ، ثم يعود كما كان ، وهكذا دواليك . الاحتمال الثاني أن يكون السؤال عن الحكمة في ذلك ، لا عن السبب الطبيعي ، أما إذا نظرنا إلى السؤال وجوابه معا ، وهو ( قُلْ هي مواقيت للناس تعين أن يكون السؤال عن الحكمة فقط ، دون السبب الطبيعي ، وهذا هو الأرجح عملا بمبدأ مطابقة الجواب للسؤال .</p>
            <p>أما قول من قال : انهم سألوا عن السبب الطبيعي ، وان الله سبحانه أمر نبيه أن يجيبهم ببيان الحكمة تعريضا بأن سؤالهم في غير محله ، لأنهم عاجزون عن إدراك السبب الطبيعي الذي يحتاج إلى دراسة طويلة وعميقة ،</p>`,
            // Page 4
            `<p>ومقدمات علمية كثيرة ، وأن الأجدر بهم أن يسألوا عن الحكمة والفائدة في اختلاف الأهلة ، حيث يمكنهم فهمها وهضمها - أما هذا القول فمجرد احتمال لا يستند إلى دليل سوى الاستحسان .</p>
            <p>وتقول : ان الدليل موجود ، وهو قوله تعالى : ليس البر بأن تأتوا البيوت من ظهورها ، لأن معناه أن سؤالكم عن السبب الطبيعي كمن يطلب دخول البيت من ظهره ، أما سؤالكم عن الحكمة فهو كمن يطلب دخول البيت من بابه .</p>
            <p>الجواب : أولا ان هذا اجتهاد في تأويل اللفظ ، وليس تفسيرا لظاهر اللفظ .</p>
            <p>ثانيا لقد ثبت أن هذه الجملة نزلت في ما كان يفعله أهل الجاهلية إذا أحرموا من إتيان البيت من ظهره ..</p>
            <p>ومهما يكن ، فان الله سبحانه أمر نبيه الأكرم صلى الله عليه واله وسلم أن يجيبهم بأن الحكمة من اختلاف الأهلة هي توقيت مصالحهم وأمورهم الدنيوية كالديون والإجارات، وأمورهم الدينية كالحج والصوم .</p>
            <p>ولَيْسَ الْبِرُّ بِأَنْ تَأْتُوا الْبُيُوتَ من ظهورها ولكن البر من اتقى وأتوا البيوت من أبوابها . قال أكثر المفسرين : ان أهل الجاهلية كان إذا أحرم أحدهم نقب نقبا في ظهر بيته ودخل منه ، أو اتخذ سلما يصعد منه إلى سطحالبيت ، وان كان من أهل الوبر خرج من خلف الخباء ، وكان بعض المسلمين يفعل ذلك في أول الأمر ، فنزلت الآية تبين لهم ان البر هو تقوى الله ، وعمل الخير، والتخلي عن المعاصي والرذائل ، لا بدخول البيوت من ظهورها ، وما إلى ذلك من التقاليد التي تحجب العقل عن ادراك الحقيقة ، ولا تمت إلى الدين والايمان بسبب</p>
            <p>أقول الاهلة مواقيت للناس والحج</p>
            <p>ثم أمر الله الناس ان تأتي البيوت من أبوابها ما علاقة الاهلة بإتيان البيوت من أبوابها وعدم اتيانها من ظهورها فالبوذي والهندوسي والمسيحي واليهود وباقي أصحاب الاعتقادات هؤلاء جميعا ما علاقتهم بالحج واتيان البيوت . نعم لو كان الخطاب موجه للذين آمنوا لكان الأمر يختلف ولكنه موجه إلى الناس .</p>
            <p>قال تعالى يخاطب رسوله الأمين صلى الله عليه وسلم يا أيها الناس أني رسول الله إليكم جميعا .......</p>
            <p>تفسير الميزان</p>
            <p>قوله تعالى : (يسئلونك) إلى قوله : والحج الأهلة جمع هلال ويسمى القمر هلالا أول الشهر القمري إذا خرج من تحت شعاع الشمس الليلة الأولى والثانية كما قيل ، وقال بعضهم الليالي الثلاثة الأول ، وقال بعضهم حتى يتحجر، والتحجر أن يستدير بخطة دقيقة</p>
            <p>وقال بعضهم : حتى يبهر نوره ظلمة الليل وذلك في الليلة السابعة ثم يسمى قمرا ويسمى في الرابعة عشر بدرا، واسمه العام عند العرب الزبرقان .</p>
            <p>والهلال مأخوذ من استهل الصبي إذا بكى عند الولادة أو صاح ، ومن قولهم : أهل القوم بالحج إذا رفعوا أصواتهم بالتلبية ، سمي به لأن الناس يهلون بذكره إذا رأوه .</p>
            <p>والمواقيت جمع ميقات وهو الوقت المضروب للفعل ، ويطلق أيضا : على المكان المعين للفعل كميقات أهل الشام وميقات أهل اليمن ، والمراد هاهنا الأول .</p>
            <p>وفي قوله تعالى : يسئلونك عن الأهلة، وإن لم يشرح أن السؤال في أمرها عن ما ذا ؟ عن حقيقة القمر وسبب تشكلاتها المختلفة في صور الهلال والقمر والبدر كما قيل ، أو عن حقيقة الهلال فقط ، الظاهر بعد المحاق في أول الشهر القمري كما ذكره بعضهم ، أو عن غير ذلك .</p>`,
            // Page 5
            `<p>ولكن إتيان الهلال في السؤال بصورة الجمع حيث قيل : يسئلونك عن الأهلة دليل على أن السؤال لم يكن عن ماهية القمر واختلاف تشكلاته إذ لو كان كذلك لكان الأنسب أن يقال : يسألونك عن القمر لا عن الأهلة ، وأيضا لوكان السؤال عن حقيقة الهلال وسبب تشكله الخاص كان الأنسب أن يقال : يسألونك عن الهلال إذ لا غرض حينئذ يتعلق بالجمع ، ففي إتيان الأهلة بصيغة الجمع دلالة على أن السؤال إنما كان عن السبب أو الفائدة في ظهور القمر هلالا بعد هلال ورسمه الشهور القمرية ، وعبر عن ذلك بالأهلة لأنها هي المحققة لذلك فأجيب بالفائدة .</p>
            <p>ويستفاد ذلك من خصوص الجواب : قل هي مواقيت للناس والحج ، فإن المواقيت وهي الأزمان المضروبة للأفعال ، والأعمال إنما هي الشهور دون الأهلة التي ليست بأزمنة وإنما هي أشكال وصور في القمر</p>
            <p>وبالجملة قد تحصل أن الغرض في السؤال إنما كان متعلقا بشأن الشهور القمرية من حيث السبب أو الفائدة فأجيب ببيان الفائدة وأنها أزمان وأوقات مضروبة للناس في أمور معاشهم ومعادهم فإن الإنسان لا بد له من حيث الخلقة من أن يقدر أفعاله وأعماله التي جميعها من سنخ الحركة بالزمان ، ولازم ذلك أن يتقطع الزمان الممتد الذي ينطبق عليه أمورهم قطعا صغارا وكبارا مثل الليل والنهار واليوم والشهر والفصول والسنين بالعناية الإلهية التي تدبر أمور خلقه وتهديهم إلى صلاح حياته، والتقطيع الظاهر الذي يستفيد منه العالم. والجاهل والبدوي والحضري ويسهل حفظه على الجميع إنما هو تقطيع الأيام بالشهور القمرية التي يدركه كل صحيح الإدراك مستقيم الحواس من الناس دون الشهور الشمسية التي ما تنبه لشأنها ولم يتل دقيق حسابها الإنسان إلا بعد قرون وأحقاب من بدء حياته في الأرض وهو مع ذلك ليس في وسع جميع الناس دائما .</p>
            <p>فالشهور القمرية أوقات مضروبة معينة للناس في أمور دينهم ودنياهم وللحج خاصة فإنه أشهر معلومات .</p>
            <p>أقول / حاول العلامة الطبطبائي قدس سره أن يخرج عن الإجماع ولكنه لم يستطع الأمور الله اعلم بها فهو قد نبه على معنى آخر للهلال</p>
            <p>بقوله : والهلال مأخوذ من استهل الصبي إذا بكى عند الولادة أو صاح ، ومن قولهم : أهل القوم بالحج إذا رفعوا أصواتهم بالتلبية، سمي به لأن الناس يهلون بذكره إذا رأوا لكنه لم يطبقه على بيان الأهلة .</p>
            <p>كما قدم قدس سره أسئلة في غاية الدقة ولكنه لم يجب عليها إلا بجواب أهل التفسير حيث قال :</p>
            <p>ولكن إتيان الهلال في السؤال بصورة الجمع حيث قيل : يسئلونك عن الأهلة دليل على أن السؤال لم يكن عن ماهية القمر واختلاف تشكلاته إذ لو كان كذلك لكان الأنسب أن يقال: يسألونك عن القمر لا عن الأهلة ، وأيضا لوكان السؤال عن حقيقة الهلال وسبب تشكله الخاص كان الأنسب أن يقال : يسألونك عن الهلال إذ لا غرض حينئذ يتعلق بالجمع، ففي إتيان الأهلة بصيغة الجمع دلالة على أن السؤال إنما كان عن السبب أو الفائدة في ظهور القمر هلالا بعد هلال ورسمه الشهور القمرية ، وعبر عن ذلك بالأهلة لأنها هي المحققة لذلك فأجيب بالفائدة.</p>
            <p>وبطبيعة الحال هذا الجواب مردود لأن العرب كما عرفنا يمتلكون إرثا معرفيا بعلم الفلك وكان لديهم تقويما قمريا شمسيا فيه شهورهم ثابته وقد نظموا أمورهم الزراعية والتجارية والعبادية وفق مواقيت ثابته ومعلومة فلا حاجة أن يسألوا عن الأهلة كي يأتيهم الجواب بما يعرفون .</p>`,
            // Page 6
            `<p>هذه الآية الكريمة تتكلم عن مسألة مهمة جدا لا علاقة لها بالقمر واطواره علما ان القرآن الكريم لم يذكر الا كلمة قمر في القرآن الكريم .</p>
            <p>أجمعت الأمة على أن النبي صلى الله عليه واله وسلم لما قدم إلى المدينة أسس دولة ونظم شؤونها من جميع النواحي وكتب معاهدات بينه وبين من حوله ومن ضمنها ما ذكره أهل الاخبار وهو عهده صلى الله عليه واله وسلم مع قبائل اليهود التي كانت تساكنه المدينة جاء فيه ما يلي :</p>
            <p>إن يهود بني عوف أمة مع المؤمنين، لليهود دينهم وللمسلمين دينهم مواليهم وأنفسهم . وإن على اليهود نفقتهم، وعلى المسلمين نفقتهم . وإن بينهم النصر على من حارب أهل هذه الصحيفة. وإن بينهم النصح والنصيحة ، والبر دون الإثم .</p>
            <p>وإنه لا يأثم امرؤ بحليفه. وإن النصر للمظلوم. وإن اليهود ينفقون مع المؤمنين ما داموا محاربين.</p>
            <p>ونظم ايضا الأمور التجارية والمالية وفق النص القرآني كقوله تعالى يأيها الذين امنوا إِذَا تَدَايَنتُم بِدَيْنِ إِلَى" أجَلٍ مُّسَمًّى فَاكْتُبُوهُ وَلْيَكْتُب بيْنَكُم كَاتِبٌ بِالْعَدْلِ وَلا يَأْبَ كَاتِبٌ أن يكتب كَمَا عَلَّمَهُ اللهُ فَلْيَكْتُبْ وَلْيُمْلِلِ الَّذِي عَلَيْهِ الْحَقُّ وَلْيَتَّقِ اللهَ رَبَّه ...... إلى آخر الآيات</p>
            <p>وقوله تعالى يا أيها النبي حرض الْمُؤْمِنِينَ على القتال إن يكن مِّنكُمْ عِشْرُونَ صَابِرُونَ يَغْلِبُوا مِائَتَيْنِ وَإِن يَكُن مِّنكُم مِائَةً يَغْلِبُوا أَلفا مِنَ الَّذِينَ كَفَرُوا بِأَنَّهُمْ قَوْمٌ لَّا يَفْقَهُونَ</p>
            <p>وقال تعالى ما عَلَى الرَّسُولِ إِلَّا البلاغ والله يَعْلَمُ مَا تُبْدُونَ وَمَا تَكْتُمُونَ.</p>
            <p>وقال وَإِن ما نيرنك بَعْضَ الَّذي نَعِدُهُمْ أو لتوفيلك فَإنَّما عَلَيْكَ الْبَلَاغُ وَعَلَيْنَا الْحِسَابُ</p>
            <p>وقال يَا أَيُّهَا الرَّسُولُ بَلَغَ مَا أُنزِلَ إِلَيْكَ مِن رَّبِّكَ وإن لم تفعل فما بلغت رسالته والله يَعْصِمُكَ مِنَ النَّاسِ ۚ إِنَّ اللَّهَ لَا يَهْدِي الْقَوْمَ الْكَافِرِينَ</p>
            <p>هذه الآيات وغيرها الكثير تحتاج من النبي صلى الله عليه واله وسلم قائد الدولة أن يوجه البلاغات والتبليغات إلى المجتمع الذي يحكمه فكانت الوسيلة الإعلامية الوحيدة في ذلك الوقت هو إرسال المبلغين إلى إحياء المدينة والمناطق التي تحت سلطته فكان المبلغ أما أن يرفع صوته بالتبليغ أو أن يطرق الأبواب لا أن يأتي ظهرها ويرفع الصوت فيدخل الفزع بقلوب من في الدار أو الحي اذا كان التبليغ خاصا</p>
            <p>هذا الأمر التنظيمي كان غير متعارف فجاوا يسألونه عن الأهلة التي هي جمع هلال الذي معناه رفع الصوت فأجابهم بجواب السماء هي مواقيت للناس والحج الذي هو أيضا يجب إعلام جميع الناس به. ولله على الناس حج البيت من استطاع إليه سبيلا .</p>
            <p>خبر صوموا لرؤيته وأفطروا لرؤيته .</p>
            <p>من كتاب فيض العليم في معرفة التقويم السماحة السيد الاستاذ فرقد الحسيني :</p>
            <p>سؤال : هل ورد عن المعصوم ما يوجب عدم العمل بخبر صوموا لرؤيته وأفطروا لرؤيته ؟</p>
            <p>الجواب : قبل الإجابة لنطلع معا على ما ورد عن المعصوم من قواعد عامة يجب أن يسير عليها من اتبعهم في معرفة كيفية الأخذ بالحديث والعمل به .</p>`,
            // Page 7
            `<p>اذكر ما ورد في وسائل الشيعة باعتباره الكتاب الجامع تقريبا لجميع الاخبار الواردة عنهم عليهم السلام :</p>
            <p>اولا : عن عمر بن حنظلة ، قال : سألت أبا عبد الله عليه السلام عن رجلين من أصحابنا بينهما منازعة في دين أو ميراث فتحاكما ... - إلى أن قال : - فان كان كل واحد اختار رجلا من أصحابنا فرضيا أن يكونا الناظرين في حقهما واختلف فيهما حكما وكلاهما اختلفا في حديثكم ؟ فقال : الحكم ما حكم به أعدلهما ، وأفقههما ، وأصدقهما ، في الحديث ، وأورعهما ، ولا يلتفت إلى ما يحكم به الآخر . قال : فقلت : فانهما عدلان مرضيان عند أصحابنا ، لا يفضل واحد منهما على صاحبه قال : ينظر إلى ما كان من روايتهما عنا في ذلك الذي حكما به ، المجمع عليه عند أصحابك ، فيؤخذ به من حكمنا ويترك الشاذ الذي ليس بمشهور عند أصحابك فان المجمع عليه لا ريب فيه - إلى أن قال : فان كان الخبران عنكم مشهورين قد رواهما الثقات عنكم ؟ قال : ينظر ، فما وافق حكمه حكم الكتاب والسنة وخالف العامة فيؤخذ به ويترك ما خالف حكمه حكم الكتاب والسنة ووافق العامة ، قلت : جعلت فداك ، إن رأيت إن كان الفقيهان عرفا حكمه من الكتاب والسنة ، ووجدنا أحد الخبرين موافقا للعامة ، والآخر مخالفا لهم بأي الخبرين يؤخذ ؟ . فقال : ما خالف العامة ففيه الرشاد فقلت : جعلت فداك ، فإن وافقهما الخبران جميعا ؟ قال : ينظر إلى ما هم إليه أميل حكامهم وقضاتهم فيترك ويؤخذ بالآخر . قلت :</p>
            <p>فإن وافق حكامهم الخبرين جميعا ؟</p>
            <p>قال : إذا كان ذلك فأرجئه حتى تلقى إمامك فإن الوقوف عند الشبهات خير من الاقتحام في الهلكات .</p>
            <p>ورواه الشيخ بإسناده عن محمد بن علي بن محبوب، عن محمد بن عيسى نحوه . ورواه الصدوق بإسناده عن داود بن الحصين ، إلا أنه قال : وخالف العامة فيؤخذ به. ورواه الطبرسي في الاحتجاج عن عمر بن حنظلة نحوه .</p>
            <p>ثانيا : عن نصر الخثعمي ، قال : سمعت أبا عبد الله عليه السلام يقول : من عرف أنا لا نقول إلا حقاً ، فليكتف بما يعلم منا ، فإن سمع منا خلاف ما يعلم ، فليعلم أن ذلك دفاع منا عنه</p>
            <p>ثالثا : عن الحسين بن المختار ، عن بعض أصحابنا ، عن أبي عبد الله عليه السلام ، قال : أرأيتك لو حدثتك بحديث العام ، ثم جئتني من قابل فحدثتك بخلافه ، بأيهما كنت تأخذ ؟ قال : كنت اخذ بالأخير ، فقال لي : رحمك الله .</p>
            <p>قال صاحب الوسائل أقول : يظهر من الصدوق أنه حمله على زمان الامام خاصة فانه قال في توجيهه : إن كل إمام أعلم بأحكام زمانه من غيره من الناس ، انتهى</p>
            <p>اقول : ما يفعل الشيعة في زمن الغيبة فضلا عن كيفية اعتماد أخبارهم اذا كان الإمام ناظرا إلى حال المجتمع الذي يعيش فيه فقط</p>
            <p>رابعا : عن المعلى بن خنيس ، قال : قلت لابي عبد الله عليه السلام : إذا جاء حديث عن أولكم وحديث عن آخركم ، بأيهما نأخذ ؟ فقال : خذوا به حتى يبلغكم عن الحي ، فإن بلغكم عن الحي فخذوا بقوله : قال : ثم قال أبو عبد الله عليه السلام : إنا - والله - لا ندخلكم إلا فيما يسعكم ..</p>
            <p>قال الكليني : وفي حديث آخر : خذوا بالأحدث .</p>
            <p>خامسا : عن السكوني، عن أبي عبد الله عليه السلام ، قال : قال رسول الله صلى الله عليه وآله : إن على كل حق حقيقة ، وعلى كل صواب نورا ، فما وافق كتاب الله فخذوه ، وما خالف كتاب الله فدعوه . ورواه البرقي في المحاسن عن النوفلي ، ورواه الصدوق في الأمالي عن أحمد بن علي بن إبراهيم ، عن أبيه مثله .</p>`,
            // Page 8
            `<p>سادسا : عن أبان بن عثمان ، عن عبد الله بن أبي يعفور ، قال : وحدثني الحسين بن أبي العلاء ، أنه حضر ابن أبي يعفور في هذا المجلس ، قال : سألت أبا عبد الله عليه السلام عن اختلاف الحديث ، يرويه من نثق به ، ومنهم من لا نثق به . قال : إذا ورد عليكم حديث فوجدتم له شاهدا من كتاب الله أو من قول رسول الله صلى الله عليه واله وإلا فالذي جاءكم به أولى به .</p>
            <p>ورواه البرقي في المحاسن عن علي بن الحكم مثله .</p>
            <p>بيان ما ورد عن أهل البيت عليهم السلام في كيفية الأخذ بالحديث والعمل به</p>
            <p>القواعد المستنبطة مما تقدم :</p>
            <p>القاعدة الأولى : عرض الحديث على كتاب الله تعالى فما وافق الكتاب يعمل به ويترك ما عارضه وهذه القاعدة تخالف قول من قال : إن الحديث ناسخ للقرآن واذا تعارضا يأخذ بالحديث</p>
            <p>القاعدة الثانية : مخالفة ما عليه العامة اذا وجد خبر عن المعصوم يخالف قولهم .</p>
            <p>القاعدة الثالثة : الأخذ بقول الراوي لحديثهم المتصف بالأفقة والاعدل والأورع فلا مجال للعقل واستنباطه</p>
            <p>القاعدة الرابعة : الأخبار الواردة عنهم عليهم السلام المماثلة لقول العامة محمولة على التقية . بعد هذه القواعد الأربعة الرئيسية : نجيب على السؤال ..</p>
            <p>الجواب :</p>
            <p>ورد في وسائل الشيعة في كتاب الصوم ما يلي :</p>
            <p>أولا : عن صفوان بن يحيى ، عن محمد بن عثمان الخدري عن بعض مشايخه ، عن أبي عبد الله عليه السلام قال : صم في العام المستقبل اليوم الخامس من يوم صمت فيه عام أول .</p>
            <p>ثانياً : عن السياري قال : كتب محمد بن الفرج إلى العسكري عليه السلام يسأله عما روي من الحساب في الصوم عن آبائك عليهم السلام في عد خمسة أيام بين أول السنة الماضية والسنة الثانية التي تأتي فكتب : صحيح ولكن عد في كل أربع سنين خمسا ، وفي السنة الخامسة سنا فيما بين الأولى والحادث وما سوى ذلك فإنما هو خمسة خمسة ، قال السياري : وهذه من جهة الكبيسة ، قال : وقد حسبه أصحابنا فوجدوه صحيحا ، قال : وكتب إليه محمد بن الفرج في سنة ثمان وثلاثين ومائتين : هذا الحساب لا يتهيا لكل إنسان أن يعمل عليه إنما هذا لمن يعرف السنين ومن يعلم متى كانت السنة الكبيسة ثم يصح له هلال شهر رمضان أول ليلة ، فاذا صح الهلال لليلته وعرف السنين صح له ذلك ، إن شاء الله .</p>
            <p>ثالثا: عن عمران الزعفراني قال : قلت لأبي عبد الله عليه السلام : إن السماء تطبق علينا بالعراق اليومين والثلاثة ، فأي يوم نصوم ؟</p>
            <p>قال : انظروا اليوم الذي صمت من السنة الماضية وصم يوم الخامس . ورواه الصدوق في المقنع عن عمران الزعفراني مثله</p>
            <p>وعن عدة من أصحابنا ، عن سهل بن زياد، عن منصور بن العباس ، عن إبراهيم بن الأحول ، عن عمران الزعفراني نحوه . ورواه الشيخ بإسناده عن محمد بن يعقوب .</p>
            <p>قال صاحب الوسائل : أقول : حمله الشيخ وغيره على الاستحباب ، وأنه يصوم على أنه من شعبان لما مضى</p>`,
            // Page 9
            `<p>رابعا : عن محمد بن علي بن الحسين قال : قال عليه السلام : إذا صمت شهر رمضان في العام الماضي في يوم معلوم فعد في العام المستقبل من ذلك اليوم خمسة أيام وصم يوم الخامس .</p>
            <p>يعلق صاحب الوسائل وغيره على هذه الروايات بقولهم مضى عدم وجوب الصوم إلا بالرؤية أو مضي ثلاثين يوما .</p>
            <p>اقول : أوليس خبر صوموا لرؤيته وأفطروا لرؤيته هو خبر العامة والمعصوم قد أفصح وبين أن ما ورد عنهم مماثلا لقول العامة محمول على التقية ؟ أوليس المعصوم قد قال في مخالفتهم الرشاد ؟ أما قالوا عليهم السلام اعرضوا الحديث على كتاب الله تعالى ..</p>
            <p>ألم يطلعوا على ما ورد في كتب العامة أن الحديث نفسه قد تسلل إلى كتبهم بنفس اللفظ باختلاف السند " لاحظ معي أيها القارئ المتدبر كيف تم تخريج صوموا لرؤيته وأفطروا لرؤيته حتى توهم العامة والخاصة أنه حديث متواتر بل بعض العامة لا تدري أهو نص قرآني أم حديث</p>
            <p>تخريج حديث صوموا لرؤيته وأفطروا لرؤيته</p>
            <p>قالوا عنه متفق عليه : وهو من حديث أبي هريرة, وله عنه طرق :</p>
            <p>الأولى : عن محمد بن زياد عنه به وزاد : فإن غبى عليكم فأكلموا عدة شعبان ثلاثين.</p>
            <p>أخرجه البخاري : ج ٤ ص ١٠٦ فتح الباري ومسلم : ج ٣ ص ١٢٤</p>
            <p>والنسائي : ج ۱ ص ۳۰۱ والدارمي : ج ۲ ص ۳ والطحاوي في مشكل الآثار ج ۱ ص ۲۰۹ والبيهقي : ج : ص ٢٠٦ والطيالس في مسنده : ص ٣٤٨١ وأحمد بن حنبل في مسنده : ج ٢ ص ٤١٥ و ٤٣٠ و ٤٥٤ و ٤٥٦</p>
            <p>و ٤٦٩ من طرق عنه واللفظ للبخاري</p>
            <p>والثانية : عن سعيد بن المسيب عنه مرفوعا بلفظ: إذا رأيتم الهلال فصوموا وإذا رأيتموه فأفطروا فإن غم</p>
            <p>عليكم فصوموا ثلاثين يوما .</p>
            <p>أخرجه مسلم والنسائي وابن الجارود في المنتقى ص ٣٩٥</p>
            <p>والدارقطني في سننه ص ۲۲۹ والبيهقي وأحمد ج ۲ ص ٢٦٣ وكذا الطيالسي : ٢٣٠٦ من طرق عن الزهري عنه</p>
            <p>والثالثة : عن الأعرج عنه وهي هي مثل رواية سعيد إلا أنه قال: فعدوا ثلاثين أخرجه مسلم والنسائي, والبيهقي وأحمد : ج ۲ ص ۲۸۷</p>
            <p>والرابعة : عن أبي سلمة عنه أخرجه الترمذي : ج ۱ ص ۱۳۳</p>
            <p>والدارقطني وأحمد : ج ٢ ص ٢٥٩ و ٤٣٨ و ٤٩٧. وقال الترمذي : حديث حسن صحيح .</p>
            <p>والخامسة : عن عطاء عنه أخرجه أحمد : ج ٢ ص ٤٢٣</p>
            <p>من طريق الحجاج عن عطاء به. ورجاله ثقات غير أن الحجاج وهو ابن أرطاة مدلس وقد عنعنه والسادسة : عن سعد بن إبراهيم عنه أخرجه البيهقي : ج ٤ ص ٢٤٧ بسند صحيح.</p>
            <p>تلاحظ عزيزي خبر واحد بالفاظ متعددة والرواي واحد : هكذا أصبح هذه الخبر الواحد الذي أخرجه ابن أبي العوجاء من كيس أبي هريرة تشريعا تسير عليه الأمة.</p>
            <p>من كتاب فيض العليم في معرفة التقويم للسيد الأستاذ فرقد الحسيني القزويني دام فيضه</p>`
        ];

        function isLeapYear(year) {
            return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        }

        function getTodayIndexAndYear() {
            const today = new Date();
            let year = today.getFullYear();
            const calendarStart = new Date(year, 9, 16);
            if (today < calendarStart) year--;
            const timeDiff = today - new Date(year, 9, 16);
            const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            return { index: daysDiff, year };
        }

        function getCustomDate(index, year) {
            const baseDate = new Date(year, 9, 16);
            baseDate.setDate(baseDate.getDate() + index);
            const dayOfWeek = baseDate.toLocaleDateString('ar-EG', { weekday: 'long', timeZone: selectedTimezone });
            const gregYear = baseDate.getFullYear();
            const customYear = 1404 + (year - 2024);
            const isEndYearLeap = isLeapYear(year + 1);
            const specialDays = isEndYearLeap ? [...baseSpecialDays, "يوم التقويم السادس"] : [...baseSpecialDays];
            let dayName = index >= 360 ? specialDays[index - 360] : `${(index % 30) + 1} ${months[Math.floor(index / 30)]}`;
            const dayNum = baseDate.getDate();
            const monthNum = baseDate.getMonth();
            const syriacMonth = syriacMonths[monthNum];
            const gregorianDate = `الموافق ${dayNum} ${syriacMonth} ${gregYear} (التقويم الشمسي الحالي)`;
            return { text: `${dayOfWeek} ${dayName} لسنة ${customYear} من الهجرة (تقويم محمدى)`, date: baseDate, gregorian: gregorianDate, year: customYear };
        }
        
        function getOccasion(index, year) {
            const isEndYearLeap = isLeapYear(year + 1);
            const specialDays = isEndYearLeap ? [...baseSpecialDays, "يوم التقويم السادس"] : [...baseSpecialDays];
            const currentMonth = index >= 360 ? null : months[Math.floor(index / 30)];
            const currentDay = index >= 360 ? specialDays[index - 360] : (index % 30) + 1;
            for (const occ of occasions) {
                if (currentMonth && occ.month === currentMonth && occ.day == currentDay) return occ.occasion;
                if (occ.day === 30 && currentMonth && occ.month === currentMonth && currentDay === 30) return occ.occasion;
            }
            return null;
        }
        
        function getMansionInfo(index, year) {
            const isEndYearLeap = isLeapYear(year + 1);
            if (isEndYearLeap && index === 365) return mansions[27];
            const cycleIndex = index % 365;
            const baseDate = new Date(2024, 9, 16);
            const ranges = mansions.map((mansion, i) => {
                const date = new Date(mansion["التاريخ"]);
                const timeDiff = date - baseDate;
                const startIndex = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const isJabha = mansion["الطالع بالغداة"] === "الجبهة";
                const endIndex = startIndex + (isJabha ? 13 : 12);
                return { start: startIndex % 365, end: endIndex % 365, mansion, index: i };
            });
            for (const range of ranges) {
                if (range.start <= range.end && cycleIndex >= range.start && cycleIndex <= range.end) return { ...range.mansion, rangeIndex: range.index };
                if (range.start > range.end && (cycleIndex >= range.start || cycleIndex <= range.end)) return { ...range.mansion, rangeIndex: range.index };
            }
            return null;
        }

        function formatTime(date) {
            if (isNaN(date.getTime())) return '--';
            return date.toLocaleTimeString('ar-EG', { timeZone: selectedTimezone, hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function formatRemainingTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours} ساعة ${minutes} دقيقة ${seconds} ثانية`;
        }

        // Find time when sun reaches a specific altitude after a reference time (for setting events)
        function getTimeAtAltitudeAfter(date, lat, lng, targetAltitudeDegrees, startTime) {
            const targetAltitude = targetAltitudeDegrees * Math.PI / 180;
            let low = startTime.getTime();
            let high = low + 3 * 60 * 60 * 1000;
            while (high - low > 1000) {
                const mid = (low + high) / 2;
                const midDate = new Date(mid);
                const position = SunCalc.getPosition(midDate, lat, lng);
                if (position.altitude > targetAltitude) {
                    low = mid;
                } else {
                    high = mid;
                }
            }
            return new Date(low);
        }

        // Find time when sun rises to a specific altitude before a reference time (for rising events like Fajr)
        function getTimeAtAltitudeBefore(date, lat, lng, targetAltitudeDegrees, endTime) {
            const targetAltitude = targetAltitudeDegrees * Math.PI / 180;
            let low = endTime.getTime() - 4 * 60 * 60 * 1000;
            let high = endTime.getTime();
            while (high - low > 1000) {
                const mid = (low + high) / 2;
                const midDate = new Date(mid);
                const position = SunCalc.getPosition(midDate, lat, lng);
                if (position.altitude < targetAltitude) {
                    low = mid;
                } else {
                    high = mid;
                }
            }
            return new Date(high);
        }

        // Shia Ithna Ashari prayer time calculation (Tehran/Jafari method)
        // Fajr: sun at -17.7° (rising), Maghrib: sun at -4.5° (setting)
        // Midnight: midpoint sunset to Fajr (Shia jurisprudence)
        // Reference: Institute of Geophysics, University of Tehran / holynajaf.net
        function getPrayerTimes(date, lat, lng) {
            const times = SunCalc.getTimes(date, lat, lng);
            const sunset = times.sunset;
            const sunrise = times.sunrise;

            // Fajr: sun at -17.7° below horizon (Tehran/Shia method)
            const fajrTime = getTimeAtAltitudeBefore(date, lat, lng, -17.7, sunrise);

            // Maghrib: sun at -4.5° below horizon after sunset (Tehran/Shia method)
            const maghribTime = getTimeAtAltitudeAfter(date, lat, lng, -4.5, sunset);

            // Tomorrow's Fajr for midnight calculation
            const tomorrow = new Date(date);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowTimes = SunCalc.getTimes(tomorrow, lat, lng);
            const nextFajr = getTimeAtAltitudeBefore(tomorrow, lat, lng, -17.7, tomorrowTimes.sunrise);

            // Midnight (Shia): midpoint between sunset and next Fajr
            const nightDuration = nextFajr.getTime() - sunset.getTime();
            const nightPrayer = new Date(sunset.getTime() + nightDuration / 2);

            return {
                fajr: fajrTime, // Fajr at -17.7° (Tehran/Shia)
                nauticalDawn: times.nauticalDawn, // -12° for reference
                sunrise: sunrise,
                solarNoon: times.solarNoon,
                sunset: sunset,
                maghrib: maghribTime, // Maghrib at -4.5° (Tehran/Shia)
                civilDusk: times.dusk, // Civil dusk at -6° for reference
                iftar: new Date(maghribTime.getTime() + 15 * 60 * 1000),
                nightPrayer: nightPrayer // Shia midnight: midpoint sunset to Fajr
            };
        }

        function getNextPrayerTime(currentTime, prayerTimes, date, lat, lng) {
            const prayerList = [
                { name: 'صلاة الفجر', display: 'صلاة الفجر', time: prayerTimes.fajr },
                { name: 'طلوع الشمس', display: 'طلوع الشمس', time: prayerTimes.sunrise },
                { name: 'صلاة الظهر', display: 'صلاة الظهر', time: prayerTimes.solarNoon },
                { name: 'صلاة المغرب', display: 'صلاة المغرب', time: prayerTimes.maghrib }
            ];
            const currentTimeMs = currentTime.getTime();
            let minDiff = Infinity;
            let nextPrayer = null;
            for (const prayer of prayerList) {
                if (!prayer.time || isNaN(prayer.time.getTime())) continue;
                const prayerMs = prayer.time.getTime();
                const diff = prayerMs - currentTimeMs;
                if (diff > 0 && diff < minDiff) {
                    minDiff = diff;
                    nextPrayer = prayer;
                }
            }
            if (!nextPrayer) {
                const tomorrow = new Date(date);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowPrayerTimes = getPrayerTimes(tomorrow, lat, lng);
                const tomorrowList = [
                    { name: 'صلاة الفجر', display: 'صلاة الفجر', time: tomorrowPrayerTimes.fajr },
                    { name: 'طلوع الشمس', display: 'طلوع الشمس', time: tomorrowPrayerTimes.sunrise },
                    { name: 'صلاة الظهر', display: 'صلاة الظهر', time: tomorrowPrayerTimes.solarNoon },
                    { name: 'صلاة المغرب', display: 'صلاة المغرب', time: tomorrowPrayerTimes.maghrib }
                ];
                for (const prayer of tomorrowList) {
                    if (!prayer.time || isNaN(prayer.time.getTime())) continue;
                    const prayerMs = prayer.time.getTime();
                    const diff = prayerMs - currentTimeMs;
                    if (diff > 0 && diff < minDiff) {
                        minDiff = diff;
                        nextPrayer = prayer;
                    }
                }
            }
            return { name: nextPrayer.display, time: nextPrayer.time, remaining: minDiff };
        }

        function updateTodaySection() {
            const { text, gregorian, date } = getCustomDate(todayIndex, todayGregYear);
            document.getElementById('muhammadan-date').textContent = text;
            document.getElementById('gregorian-date').textContent = gregorian;
            const occasion = getOccasion(todayIndex, todayGregYear);
            document.getElementById('occasion-info').textContent = occasion ? `المناسبات: ${occasion}` : 'المناسبات: لا يوجد';
            const mansion = getMansionInfo(todayIndex, todayGregYear);
            document.getElementById('today-mansion-info-rising').textContent = mansion ? `الطالع بالغداة: ${mansion["الطالع بالغداة"]}` : 'الطالع بالغداة: --';
            document.getElementById('today-mansion-info-setting').textContent = mansion ? `الغارب بالغداة: ${mansion["الغارب بالغداة"]}` : 'الغارب بالغداة: --';
            document.getElementById('today-mansion-info-quote').textContent = mansion ? `يقول ساجع العرب: ${mansion["يقول ساجع العرب"]}` : 'يقول ساجع العرب: --';
        }

        function updatePrayerSection() {
            const currentUTC = simulatedTime || new Date();
            const selectedCity = document.getElementById('city-select').value;
            const city = cities[selectedCity];
            // Update timezone based on selected city
            selectedTimezone = city.timezone;
            document.getElementById('current-time').textContent = `الوقت الآن: ${formatTime(currentUTC)}`;
            prayerTimes = getPrayerTimes(currentPrayerDate, city.lat, city.lng);
            document.getElementById('astronomical-twilight-start').textContent = formatTime(prayerTimes.fajr); // Fajr at -16°
            document.getElementById('sunrise').textContent = formatTime(prayerTimes.sunrise);
            document.getElementById('solar-noon').textContent = formatTime(prayerTimes.solarNoon);
            document.getElementById('sunset').textContent = formatTime(prayerTimes.sunset);
            document.getElementById('civil-twilight-end').textContent = formatTime(prayerTimes.maghrib); // Maghrib at -4°
            document.getElementById('iftar').textContent = formatTime(prayerTimes.iftar);
            document.getElementById('night-prayer').textContent = formatTime(prayerTimes.nightPrayer);
            document.getElementById('nautical-twilight-start').textContent = formatTime(prayerTimes.nauticalDawn);
            document.getElementById('civil-twilight-end2').textContent = formatTime(prayerTimes.civilDusk);
            document.getElementById('coordinates').textContent = `الإحداثيات: ${city.lat.toFixed(4)}° شمالاً، ${city.lng.toFixed(4)}° شرقاً`;
            const nextPrayer = getNextPrayerTime(currentUTC, prayerTimes, currentPrayerDate, city.lat, city.lng);
            document.getElementById('remaining-time').textContent = `متبقى ${formatRemainingTime(nextPrayer.remaining)} على ${nextPrayer.name}`;
        }

        function updateBookSection() {
            const bookContent = document.getElementById('book-content');
            bookContent.innerHTML = bookPages[currentBookPage - 1];
            document.getElementById('book-prev-page').disabled = currentBookPage === 1;
            document.getElementById('book-next-page').disabled = currentBookPage === totalBookPages;
        }

        function populateConversionPickers() {
            const customMonth = document.getElementById('conversion-custom-month');
            const customDay = document.getElementById('conversion-custom-day');
            const customYear = document.getElementById('conversion-custom-year');
            customMonth.innerHTML = '<option value="">اختر الشهر</option>';
            months.forEach((month, i) => customMonth.innerHTML += `<option value="${i}">${month}</option>`);
            customMonth.innerHTML += `<option value="special">أيام التقويم</option>`;
            for (let y = 1340; y <= 1500; y++) customYear.innerHTML += `<option value="${y}">${y}</option>`;
            function updateConversionDays() {
                const monthValue = customMonth.value;
                customDay.innerHTML = '<option value="">اختر اليوم</option>';
                if (monthValue === "") return;
                if (monthValue === "special") {
                    const isEndYearLeap = isLeapYear(baseGregYear + 1);
                    const maxDays = isEndYearLeap ? 6 : 5;
                    const specialDays = isEndYearLeap ? [...baseSpecialDays, "يوم التقويم السادس"] : [...baseSpecialDays];
                    for (let i = 1; i <= maxDays; i++) customDay.innerHTML += `<option value="${i}">${specialDays[i - 1]}</option>`;
                } else {
                    for (let i = 1; i <= 30; i++) customDay.innerHTML += `<option value="${i}">${i}</option>`;
                }
            }
            customMonth.addEventListener('change', updateConversionDays);
            updateConversionDays();
        }

        function updateConversionDisplay() {
            const { text, gregorian, date, year } = getCustomDate(baseIndex, baseGregYear);
            document.getElementById('conversion-muhammadan-date').textContent = text;
            document.getElementById('conversion-gregorian-date').textContent = gregorian;
            const occasion = getOccasion(baseIndex, baseGregYear);
            document.getElementById('conversion-occasion').textContent = occasion ? `المناسبات: ${occasion}` : 'المناسبات: لا يوجد';
            if (!isPickerChange) {
                const customMonth = document.getElementById('conversion-custom-month');
                const customDay = document.getElementById('conversion-custom-day');
                const customYear = document.getElementById('conversion-custom-year');
                const isEndYearLeap = isLeapYear(baseGregYear + 1);
                if (baseIndex >= 360) {
                    customMonth.value = "special";
                    const maxDays = isEndYearLeap ? 6 : 5;
                    const specialDays = isEndYearLeap ? [...baseSpecialDays, "يوم التقويم السادس"] : [...baseSpecialDays];
                    customDay.innerHTML = '<option value="">اختر اليوم</option>';
                    for (let i = 1; i <= maxDays; i++) customDay.innerHTML += `<option value="${i}">${specialDays[i - 1]}</option>`;
                    customDay.value = baseIndex - 359;
                } else {
                    const monthIndex = Math.floor(baseIndex / 30);
                    const day = (baseIndex % 30) + 1;
                    customMonth.value = monthIndex;
                    customDay.innerHTML = '<option value="">اختر اليوم</option>';
                    for (let i = 1; i <= 30; i++) customDay.innerHTML += `<option value="${i}">${i}</option>`;
                    customDay.value = day;
                }
                customYear.value = year;
            }
            const gregorianPicker = document.getElementById('conversion-gregorian-picker');
            const yearStr = date.getFullYear();
            const monthStr = String(date.getMonth() + 1).padStart(2, '0');
            const dayStr = String(date.getDate()).padStart(2, '0');
            gregorianPicker.value = `${yearStr}-${monthStr}-${dayStr}`;
            const mansion = getMansionInfo(baseIndex, baseGregYear);
            document.getElementById('conversion-mansion-info-rising').textContent = mansion ? `الطالع بالغداة: ${mansion["الطالع بالغداة"]}` : 'الطالع بالغداة: --';
            document.getElementById('conversion-mansion-info-setting').textContent = mansion ? `الغارب بالغداة: ${mansion["الغارب بالغداة"]}` : 'الغارب بالغداة: --';
            document.getElementById('conversion-mansion-info-quote').textContent = mansion ? `يقول ساجع العرب: ${mansion["يقول ساجع العرب"]}` : 'يقول ساجع العرب: --';
        }

        function handleConversionGregorianPicker() {
            const selectedDate = new Date(document.getElementById('conversion-gregorian-picker').value);
            let year = selectedDate.getFullYear();
            const calendarStart = new Date(year, 9, 16);
            if (selectedDate < calendarStart) year--;
            baseGregYear = year;
            const timeDiff = selectedDate - new Date(year, 9,16);
            const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            baseIndex = daysDiff;
            isPickerChange = true;
            updateConversionDisplay();
            isPickerChange = false;
            document.getElementById('slider').value = baseIndex;
        }

        function initialize() {
            const { index, year } = getTodayIndexAndYear();
            todayIndex = index;
            todayGregYear = year;
            baseIndex = index;
            baseGregYear = year;
            currentPrayerDate = new Date();
            // Set initial timezone from default selected city
            const defaultCity = cities[document.getElementById('city-select').value];
            selectedTimezone = defaultCity.timezone;
            updateTodaySection();
            updatePrayerSection();
            populateConversionPickers();
            updateConversionDisplay();
            setInterval(() => {
                if (!simulatedTime) {
                    updatePrayerSection();
                }
            }, 1000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            document.querySelectorAll('.today-container, #solar-times, .conversion-container, .book-container').forEach(container => container.style.display = 'none');
            if (tabName === 'today') document.querySelector('.today-container').style.display = 'block';
            if (tabName === 'prayer') document.querySelector('#solar-times').style.display = 'block';
            if (tabName === 'conversion') document.querySelector('.conversion-container').style.display = 'block';
            if (tabName === 'book') {
                document.querySelector('.book-container').style.display = 'block';
                updateBookSection();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initialize();
            document.getElementById('city-select').addEventListener('change', () => {
                simulatedTime = null;
                currentPrayerDate = new Date();
                updatePrayerSection();
            });
            document.getElementById('time-slider').addEventListener('input', () => {
                const minutes = parseInt(document.getElementById('time-slider').value);
                simulatedTime = new Date(currentPrayerDate);
                simulatedTime.setHours(0, 0, 0, 0);
                simulatedTime.setMinutes(minutes);
                updatePrayerSection();
            });
            document.getElementById('slider').addEventListener('input', () => {
                baseIndex = parseInt(document.getElementById('slider').value);
                updateConversionDisplay();
            });
            document.getElementById('prevDay').addEventListener('click', () => {
                baseIndex = Math.max(0, baseIndex - 1);
                document.getElementById('slider').value = baseIndex;
                updateConversionDisplay();
            });
            document.getElementById('nextDay').addEventListener('click', () => {
                const isEndYearLeap = isLeapYear(baseGregYear + 1);
                baseIndex = Math.min(isEndYearLeap ? 365 : 364, baseIndex + 1);
                document.getElementById('slider').value = baseIndex;
                updateConversionDisplay();
            });
            document.getElementById('prevCustomMonth').addEventListener('click', () => {
                const customMonth = document.getElementById('conversion-custom-month');
                const monthValue = customMonth.value;
                if (monthValue === "special") {
                    customMonth.value = months[months.length - 1];
                    baseIndex = (months.length - 1) * 30;
                } else if (monthValue !== "") {
                    const currentMonthIndex = parseInt(monthValue);
                    const newMonthIndex = currentMonthIndex === 0 ? months.length - 1 : currentMonthIndex - 1;
                    customMonth.value = newMonthIndex;
                    baseIndex = newMonthIndex * 30;
                }
                document.getElementById('slider').value = baseIndex;
                updateConversionDisplay();
            });
            document.getElementById('nextCustomMonth').addEventListener('click', () => {
                const customMonth = document.getElementById('conversion-custom-month');
                const monthValue = customMonth.value;
                const isEndYearLeap = isLeapYear(baseGregYear + 1);
                if (monthValue !== "special" && monthValue !== "") {
                    const currentMonthIndex = parseInt(monthValue);
                    const newMonthIndex = currentMonthIndex === months.length - 1 ? "special" : currentMonthIndex + 1;
                    customMonth.value = newMonthIndex;
                    baseIndex = newMonthIndex === "special" ? 360 : newMonthIndex * 30;
                } else if (monthValue === "special") {
                    customMonth.value = 0;
                    baseIndex = 0;
                    baseGregYear++;
                }
                document.getElementById('slider').value = baseIndex;
                updateConversionDisplay();
            });
            document.getElementById('prevYear').addEventListener('click', () => {
                baseGregYear--;
                const isEndYearLeap = isLeapYear(baseGregYear + 1);
                if (baseIndex > (isEndYearLeap ? 365 : 364)) baseIndex = isEndYearLeap ? 365 : 364;
                document.getElementById('slider').value = baseIndex;
                updateConversionDisplay();
            });
            document.getElementById('nextYear').addEventListener('click', () => {
                baseGregYear++;
                const isEndYearLeap = isLeapYear(baseGregYear + 1);
                if (baseIndex > (isEndYearLeap ? 365 : 364)) baseIndex = isEndYearLeap ? 365 : 364;
                document.getElementById('slider').value = baseIndex;
                updateConversionDisplay();
            });
            document.getElementById('resetDay').addEventListener('click', () => {
                const { index, year } = getTodayIndexAndYear();
                baseIndex = index;
                baseGregYear = year;
                document.getElementById('slider').value = baseIndex;
                updateConversionDisplay();
            });
            document.getElementById('conversion-custom-month').addEventListener('change', () => {
                isPickerChange = true;
                const monthValue = document.getElementById('conversion-custom-month').value;
                if (monthValue === "") return;
                if (monthValue === "special") {
                    baseIndex = 360;
                } else {
                    baseIndex = parseInt(monthValue) * 30;
                }
                document.getElementById('slider').value = baseIndex;
                updateConversionDisplay();
                isPickerChange = false;
            });
            document.getElementById('conversion-custom-day').addEventListener('change', () => {
                isPickerChange = true;
                const dayValue = document.getElementById('conversion-custom-day').value;
                const monthValue = document.getElementById('conversion-custom-month').value;
                if (dayValue === "" || monthValue === "") return;
                if (monthValue === "special") {
                    baseIndex = 360 + parseInt(dayValue) - 1;
                } else {
                    baseIndex = parseInt(monthValue) * 30 + parseInt(dayValue) - 1;
                }
                document.getElementById('slider').value = baseIndex;
                updateConversionDisplay();
                isPickerChange = false;
            });
            document.getElementById('conversion-custom-year').addEventListener('change', () => {
                isPickerChange = true;
                const yearValue = document.getElementById('conversion-custom-year').value;
                baseGregYear = parseInt(yearValue) - 1404 + 2024;
                const isEndYearLeap = isLeapYear(baseGregYear + 1);
                if (baseIndex > (isEndYearLeap ? 365 : 364)) baseIndex = isEndYearLeap ? 365 : 364;
                document.getElementById('slider').value = baseIndex;
                updateConversionDisplay();
                isPickerChange = false;
            });
            document.getElementById('conversion-gregorian-picker').addEventListener('change', handleConversionGregorianPicker);
            document.getElementById('conversion-prevMansion').addEventListener('click', () => {
                const mansion = getMansionInfo(baseIndex, baseGregYear);
                if (!mansion) return;
                let newIndex = mansion.rangeIndex - 1;
                if (newIndex < 0) newIndex = mansions.length - 1;
                const newMansion = mansions[newIndex];
                const newMansionDate = new Date(newMansion["التاريخ"]);
                let year = newMansionDate.getFullYear();
                const calendarStart = new Date(year, 9, 16);
                if (newMansionDate < calendarStart) year--;
                baseGregYear = year;
                const timeDiff = newMansionDate - new Date(year, 9, 16);
                baseIndex = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                document.getElementById('slider').value = baseIndex;
                updateConversionDisplay();
            });
            document.getElementById('conversion-nextMansion').addEventListener('click', () => {
                const mansion = getMansionInfo(baseIndex, baseGregYear);
                if (!mansion) return;
                let newIndex = (mansion.rangeIndex + 1) % mansions.length;
                const newMansion = mansions[newIndex];
                const newMansionDate = new Date(newMansion["التاريخ"]);
                let year = newMansionDate.getFullYear();
                const calendarStart = new Date(year, 9, 16);
                if (newMansionDate < calendarStart) year--;
                baseGregYear = year;
                const timeDiff = newMansionDate - new Date(year, 9, 16);
                baseIndex = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                document.getElementById('slider').value = baseIndex;
                updateConversionDisplay();
            });
            document.getElementById('book-prev-page').addEventListener('click', () => {
                if (currentBookPage > 1) {
                    currentBookPage--;
                    updateBookSection();
                }
            });
            document.getElementById('book-next-page').addEventListener('click', () => {
                if (currentBookPage < totalBookPages) {
                    currentBookPage++;
                    updateBookSection();
                }
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.getAttribute('data-tab')));
            });
        });
    </script>
</body>
</html>
